<!DOCTYPE html>




<html class="theme-next mist" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png" />
  <link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-144x144.png" />









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="GAdTib6gE0rnfH46uhf_j3PDkomJVwV2OTyonxNGS3w" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Playfair Display:300,300italic,400,400italic,700,700italic|Lato:300,300italic,400,400italic,700,700italic|Poiret One:300,300italic,400,400italic,700,700italic|Monaco-external:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Nginx,Ubuntu,Linux,Network," />





  <link rel="alternate" href="/atom.xml" title="OpenPIKA" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="One of the protocols supported is the relatively new HTTP/2, which was published in May 2015 approximately. One of the main advantages of HTTP/2 is its high transfer speed for content-rich websites. T">
<meta name="keywords" content="Nginx,Ubuntu,Linux,Network">
<meta property="og:type" content="article">
<meta property="og:title" content="Set up Nginx with HTTP&#x2F;2 Support">
<meta property="og:url" content="https://pingchuan.ma/set-up-nginx-with-http-2-support/index.html">
<meta property="og:site_name" content="OpenPIKA">
<meta property="og:description" content="One of the protocols supported is the relatively new HTTP/2, which was published in May 2015 approximately. One of the main advantages of HTTP/2 is its high transfer speed for content-rich websites. T">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://pingchuan.ma/set-up-nginx-with-http-2-support/http-1-1-vs-http-2.png">
<meta property="og:image" content="https://pingchuan.ma/set-up-nginx-with-http-2-support/protocol.png">
<meta property="og:updated_time" content="2017-08-08T17:31:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Set up Nginx with HTTP&#x2F;2 Support">
<meta name="twitter:description" content="One of the protocols supported is the relatively new HTTP/2, which was published in May 2015 approximately. One of the main advantages of HTTP/2 is its high transfer speed for content-rich websites. T">
<meta name="twitter:image" content="https://pingchuan.ma/set-up-nginx-with-http-2-support/http-1-1-vs-http-2.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://pingchuan.ma/set-up-nginx-with-http-2-support/"/>



  <link href="/vendors/google-code-prettify/themes/tomorrow.min.css" type="text/css" rel="stylesheet" />




  <title>Set up Nginx with HTTP/2 Support | OpenPIKA</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-104092499-1', 'auto');
  ga('send', 'pageview');
</script>











</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  
  
  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">OpenPIKA</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<div class="top-scroll-bar"></div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pingchuan.ma/set-up-nginx-with-http-2-support/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pingchuan Ma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OpenPIKA">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Set up Nginx with HTTP/2 Support</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-09T00:17:48+08:00">
                Aug-9-2017
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>One of the protocols supported is the relatively new <strong>HTTP/2</strong>, which was published in May 2015 approximately. One of the main advantages of HTTP/2 is its high transfer speed for content-rich websites. To boost my website as much as possible, I upgraded it with this modern protocol.</p>
<a id="more"></a>
<h2 id="What-is-HTTP-2"><a href="#What-is-HTTP-2" class="headerlink" title="What is HTTP/2?"></a>What is HTTP/2?</h2><p><strong>HTTP/2</strong> (originally named <strong>HTTP/2.0</strong>) is a major revision of the HTTP network protocol used by the World Wide Web. It was derived from the earlier experimental <strong>SPDY</strong> protocol, originally developed by Google. HTTP/2 was developed by the Hypertext Transfer Protocol working group <strong>httpbis</strong> (where <em>bis</em> means “second”) of the <a href="http://ietf.org/" target="_blank" rel="external">Internet Engineering Task Force</a>. HTTP/2 is the first new version of HTTP since HTTP 1.1, which was standardized in <a href="https://tools.ietf.org/html/rfc2068" target="_blank" rel="external">RFC 2068</a> in 1997. </p>
<h2 id="Why-HTTP-2"><a href="#Why-HTTP-2" class="headerlink" title="Why HTTP/2?"></a>Why HTTP/2?</h2><p>In a nutshell, HTTP/2 has been released to address the inherent problems of HTTP1.1:</p>
<ul>
<li><p><strong>HTTP/2 is binary</strong> instead of textual like HTTP1.1 - this makes it transfer and parsing of data over HTTP/2 inherently more machine-friendly, thus faster, more efficient and less error prone.</p>
</li>
<li><p><strong>HTTP/2 is fully multiplexed</strong> allowing multiple files and requests to be transferred at the same time, as opposed to HTTP1.1 which only accepted one single request / connection at a time.</p>
</li>
<li><p><strong>HTTP/2 uses the same connection</strong> for transferring different files and requests, avoiding the heavy operation of opening a new connection for every file which needs to be transferred between a client and a server.</p>
</li>
<li><p><strong>HTTP/2 has header compression</strong> built-in which is another way of removing several of the overheads associated with HTTP1.1 having to retrieve several different resources from the same or multiple web servers.</p>
</li>
<li><p><strong>HTTP/2 allows servers to push</strong> required resources proactively rather than waiting for the client browser to request files when it thinks it need them.</p>
</li>
</ul>
<div align="center"><br><img src="/set-up-nginx-with-http-2-support/http-1-1-vs-http-2.png" alt="HTTP 1.1 v.s. HTTP/2" title="HTTP 1.1 v.s. HTTP/2"><br></div>

<p>These things are the best (if simplistic) depiction of how HTTP/2 is better than HTTP1.1. Rather than the browser having to go back to the server to fetch every single resource, it’s picking up all the resources and transferring them at once.</p>
<h2 id="How-to-make-it"><a href="#How-to-make-it" class="headerlink" title="How to make it?"></a>How to make it?</h2><h3 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><ul>
<li><p>A <a href="https://pingchuan.ma/install-nginx-on-ubuntu/">Nginx-installed</a> Ubuntu OS.</p>
</li>
<li><p>A non-root user with the right to <code>sudo</code>.</p>
</li>
<li><p>You should have the control right of a domain name and associate it with your Nginx-running server.</p>
</li>
<li><p>An <a href="https://pingchuan.ma/equip-nginx-server-with-https/">SSL certificate</a>.</p>
</li>
</ul>
<p>My <a href="https://m.do.co/c/c037166332e8" title="Click here to get $10 in credit." target="_blank" rel="external">DigitalOcean</a> VPS is installed with Ubuntu 16.04 LTS x64. This post will also be based on it.</p>
<h3 id="Upgrade-to-the-Latest-Version-of-Nginx"><a href="#Upgrade-to-the-Latest-Version-of-Nginx" class="headerlink" title="Upgrade to the Latest Version of Nginx"></a>Upgrade to the Latest Version of Nginx</h3><p>Support of the HTTP/2 protocol was introduced in Nginx 1.9.5. If you followed my <a href="https://pingchuan.ma/install-nginx-on-ubuntu/">previous tutorial</a> about building Nginx on Ubuntu, you should have had the up-to-date Nginx, so skip this part and go to next step. Fortunately, the default repository in Ubuntu 16.04 contains a version higher than this, so we don’t have to add a third party repository.</p>
<p>First, update the list of available packages in the <code>apt</code> packaging system:</p>
<pre><code class="bash">$ sudo apt-get update
</code></pre>
<p>Then, install Nginx:</p>
<pre><code class="bash">$ sudo apt-get install nginx
</code></pre>
<p>After the installation process finishes, you can check the version of Nginx by typing:</p>
<pre><code class="bash">$ sudo nginx -v
</code></pre>
<p>The output should be similar to the following:</p>
<pre><code class="bash">nginx version: nginx/1.10.3 (Ubuntu)
</code></pre>
<p>In the next several steps, we will modify the Nginx configuration files. Each step will change an Nginx configuration option. We will test the syntax of the configuration file along the way. Finally, we will verify that Nginx supports HTTP/2 and make a few changes to optimize performance.</p>
<h3 id="Change-the-Listening-Port-and-Enabling-HTTP-2"><a href="#Change-the-Listening-Port-and-Enabling-HTTP-2" class="headerlink" title="Change the Listening Port and Enabling HTTP/2"></a>Change the Listening Port and Enabling HTTP/2</h3><p>The first change we will make will be to change the listening port from <code>80</code> to <code>443</code>.</p>
<p>Let’s open the configuration file:</p>
<pre><code class="bash">$ sudo vim /etc/nginx/sites-available/default
</code></pre>
<p>By default, Nginx is set to listen to port <code>80</code>, which is the standard HTTP port:</p>
<pre><code>. . .
listen 80 default_server;
listen [::]:80 default_server;
. . .
</code></pre><p>As you can see, we have two different <code>listen</code> variables. The first one is for all IPv4 connections. The second one is for IPv6 connections. We will enable encryption for both.</p>
<p>Modify the listening port to <code>443</code>, which is used by the HTTPS protocol:</p>
<pre><code>. . .
listen 443 ssl http2 default_server;
listen [::]:443 ssl http2 default_server;
. . .
</code></pre><p>Notice that in addition to <code>ssl</code>, we also added <code>http2</code> to the line. This variable tells Nginx to use HTTP/2 with supported browsers. Save the configuration file and exit the text editor.</p>
<p>Whenever you make changes to Nginx configuration files, you should check the configuration for syntax errors, like this:</p>
<pre><code class="bash">$ sudo nginx -t
</code></pre>
<p>If the syntax is error-free, you will see the following output:</p>
<pre><code class="bash">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</code></pre>
<h3 id="Avoid-Old-Cipher-Suites"><a href="#Avoid-Old-Cipher-Suites" class="headerlink" title="Avoid Old Cipher Suites"></a>Avoid Old Cipher Suites</h3><p>HTTP/2 has a huge blacklist of old and insecure ciphers, so we must avoid them. Cipher suites are a bunch of cryptographic algorithms, which describe how the transferring data should be encrypted.</p>
<p>We will use a really popular cipher set, whose security was approved by Internet giants like <a href="https://www.cloudflare.com" target="_blank" rel="external">CloudFlare</a>. It does not allow the usage of <a href="https://en.wikipedia.org/wiki/MD5" target="_blank" rel="external">MD5</a> encryption (which was known as insecure since 1996, but despite this fact, its use is widespread even to this day).</p>
<p>Open the following configuration file:</p>
<pre><code class="bash">$ sudo vim /etc/nginx/nginx.conf
</code></pre>
<p>Add this line after <code>ssl_prefer_server_ciphers on;</code>:</p>
<pre><code>. . .
ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
. . .
</code></pre><p>Save the file, and exit the text editor. Once again, check the configuration for syntax errors:</p>
<pre><code class="bash">$ sudo nginx -t
</code></pre>
<h3 id="Redirect-all-HTTP-Request-to-HTTPS"><a href="#Redirect-all-HTTP-Request-to-HTTPS" class="headerlink" title="Redirect all HTTP Request to HTTPS"></a>Redirect all HTTP Request to HTTPS</h3><p>Since we are interested in serving the content through HTTPS only, we should tell Nginx what it should do if the server receives an HTTP request.</p>
<p>Open the configuration file:</p>
<pre><code class="bash">$ sudo vim /etc/nginx/sites-available/default
</code></pre>
<p>At the bottom of our file, we will create a new server block for redirecting all HTTP requests to HTTPS (be sure to replace the server name with your actual domain name):</p>
<pre><code>. . .
server {
    listen 80;
    listen [::]:80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
</code></pre><p>Save the file, and exit the configuration file.</p>
<p>Check the configuration for syntax errors:</p>
<pre><code class="bash">$ sudo nginx -t
</code></pre>
<h3 id="Reload-Nginx"><a href="#Reload-Nginx" class="headerlink" title="Reload Nginx"></a>Reload Nginx</h3><p>That’s it for all the Nginx configuration changes. Since we checked for syntax errors with each change, you should be ready to restart Nginx and test your changes.</p>
<p>To summarize, ignoring commented out lines, your configuration file should now look similar to mine:</p>
<pre><code>server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;

    root /var/www/html;

    index index.html index.htm index.nginx-debian.html;

    server_name pingchuan.ma www.pingchuan.ma;

    location / {
        try_files $uri $uri/ =404;
    }

    ssl_certificate /etc/letsencrypt/live/pingchuan.ma/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pingchuan.ma/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/ssl/certs/dhparam.pem;
}

server {
    listen 80;
    listen [::]:80;
    server_name pingchuan.ma www.pingchuan.ma;
    return 301 https://$server_name$request_uri;
}
</code></pre><p>To apply the changes, restart the Nginx server.</p>
<pre><code class="bash">$ sudo systemctl restart nginx
</code></pre>
<h3 id="Verify-the-Changes"><a href="#Verify-the-Changes" class="headerlink" title="Verify the Changes"></a>Verify the Changes</h3><p>Let’s check that our server is up and running. Open your web browser and navigate to your domain.</p>
<p>If everything was configured properly, you should be automatically redirected to HTTPS. Now, let’s check that HTTP/2 is working: open the Chrome Developer Tools (<strong>View</strong> -&gt; <strong>Developer</strong> -&gt; <strong>Developer Tools</strong>) and reload the page (<strong>View</strong> -&gt; <strong>Reload This Page</strong>). Then navigate to the <strong>Network</strong> tab, click on table header row that starts with <strong>Name</strong>, right-click on it, and select the <strong>Protocol</strong> option.</p>
<p>Now you should see <code>h2</code> (which stands for HTTP/2) in a new column for your website serving HTTP/2 content.</p>
<div align="center"><br><img src="/set-up-nginx-with-http-2-support/protocol.png" alt="Protocol" title="Protocol"><br></div>

<p>At this point, our server is ready to serve content through HTTP/2 protocol, but there are still some things we should do to prepare the server to be used in production.</p>
<h3 id="Optimize-Nginx-for-Best-Performance"><a href="#Optimize-Nginx-for-Best-Performance" class="headerlink" title="Optimize Nginx for Best Performance"></a>Optimize Nginx for Best Performance</h3><p>In this step we will tune the main Nginx configuration file for best performance and security.</p>
<p>First of all, let’s open <code>nginx.conf</code> by typing the following in the console:</p>
<pre><code class="bash">$ sudo vim /etc/nginx/nginx.conf
</code></pre>
<h4 id="Enable-Connection-Credentials-Caching"><a href="#Enable-Connection-Credentials-Caching" class="headerlink" title="Enable Connection Credentials Caching"></a>Enable Connection Credentials Caching</h4><p>Compared to HTTP, HTTPS takes a relatively longer time to establish initial connection between server and user. To minimize this difference in page load speed, we will enable caching of the connection credentials. That means instead of creating a new session on every page requested, the server will use a cached version of the credentials instead.</p>
<p>To enable session caching, add these lines at the end of <code>http</code> block of your <code>nginx.conf</code> file:</p>
<pre><code>. . .
ssl_session_cache shared:SSL:5m;
ssl_session_timeout 1h;
</code></pre><p><code>ssl_session_cache specifies</code> the size of cache that will contain session information. 1 MB of it can store information for about 4000 sessions. The default value of 5 MB will be more than enough for most users, but if you expect really heavy traffic, you can increase this value accordingly.</p>
<p><code>ssl_session_timeout</code> limits the time particular sessions are stored in the cache. This value shouldn’t be too big (more than an hour), but setting the value too low is pointless as well.</p>
<h4 id="Enable-HTTP-Strict-Transport-Security-HSTS"><a href="#Enable-HTTP-Strict-Transport-Security-HSTS" class="headerlink" title="Enable HTTP Strict Transport Security (HSTS)"></a>Enable HTTP Strict Transport Security (HSTS)</h4><p>Even though we have already made all regular HTTP requests redirect to HTTPS in our Nginx configuration file, we also should enable HTTP Strict Transport Security to avoid having to do those redirects in the first place.</p>
<p>If the browser finds an HSTS header, it will not try to connect to the server via regular HTTP again for the given time period. No matter what, it will exchange data using only encrypted HTTPS connection. This header should also protect us from protocol downgrade attacks.</p>
<p>Add this line in <code>nginx.conf</code>:</p>
<pre><code>. . .
add_header Strict-Transport-Security &quot;max-age=15768000&quot; always;
. . .
</code></pre><p>The <code>max-age</code> is set in seconds. <code>15768000</code> seconds is equivalent to 6 months.</p>
<p>By default, this header is not added to subdomain requests. If you have subdomains and want HSTS to apply to all of them, you should add the <code>includeSubDomains</code> variable at the end of the line, like this:</p>
<pre><code>. . .
add_header Strict-Transport-Security &quot;max-age=15768000; includeSubDomains&quot; always;
. . .
</code></pre><p>Save the file, and exit the text editor.</p>
<p>Once again, check the configuration for syntax errors:</p>
<pre><code class="bash">$ sudo nginx -t
</code></pre>
<p>Finally, restart the Nginx server to apply the changes.</p>
<pre><code class="bash">$ sudo systemctl restart nginx
</code></pre>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-with-http-2-support-on-ubuntu-16-04" target="_blank" rel="external">How To Set Up Nginx with HTTP/2 Support on Ubuntu 16.04</a></p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/HTTP/2" target="_blank" rel="external">HTTP/2 - Wikipedia</a></p>
</li>
<li><p><a href="https://css-tricks.com/http2-real-world-performance-test-analysis/" target="_blank" rel="external">HTTP/2 – A Real-World Performance Test and Analysis</a></p>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># Nginx</a>
          
            <a href="/tags/ubuntu/" rel="tag"># Ubuntu</a>
          
            <a href="/tags/linux/" rel="tag"># Linux</a>
          
            <a href="/tags/network/" rel="tag"># Network</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/equip-nginx-server-with-https/" rel="next" title="Equip Nginx Server with HTTPS">
                <i class="fa fa-chevron-left"></i> Equip Nginx Server with HTTPS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div style="text-align:center;">
        <button class="btn" id="load-disqus" onclick="disqus.load();">Load Comments</button>
      </div>
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Pingchuan Ma" />
          <p class="site-author-name" itemprop="name">Pingchuan Ma</p>
           
              <p class="site-description motion-element" itemprop="description">Woof the Woof?</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element" style="opacity: 1; display: none; transform: translateX(0px);>
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/pika7ma" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  
                  
                    GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:pika7ma@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  
                  
                    E-Mail
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-HTTP-2"><span class="nav-number">1.</span> <span class="nav-text">What is HTTP/2?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-HTTP-2"><span class="nav-number">2.</span> <span class="nav-text">Why HTTP/2?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-make-it"><span class="nav-number">3.</span> <span class="nav-text">How to make it?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prerequisites"><span class="nav-number">3.1.</span> <span class="nav-text">Prerequisites</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Upgrade-to-the-Latest-Version-of-Nginx"><span class="nav-number">3.2.</span> <span class="nav-text">Upgrade to the Latest Version of Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Change-the-Listening-Port-and-Enabling-HTTP-2"><span class="nav-number">3.3.</span> <span class="nav-text">Change the Listening Port and Enabling HTTP/2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Avoid-Old-Cipher-Suites"><span class="nav-number">3.4.</span> <span class="nav-text">Avoid Old Cipher Suites</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redirect-all-HTTP-Request-to-HTTPS"><span class="nav-number">3.5.</span> <span class="nav-text">Redirect all HTTP Request to HTTPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reload-Nginx"><span class="nav-number">3.6.</span> <span class="nav-text">Reload Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Verify-the-Changes"><span class="nav-number">3.7.</span> <span class="nav-text">Verify the Changes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Optimize-Nginx-for-Best-Performance"><span class="nav-number">3.8.</span> <span class="nav-text">Optimize Nginx for Best Performance</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-Connection-Credentials-Caching"><span class="nav-number">3.8.1.</span> <span class="nav-text">Enable Connection Credentials Caching</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-HTTP-Strict-Transport-Security-HSTS"><span class="nav-number">3.8.2.</span> <span class="nav-text">Enable HTTP Strict Transport Security (HSTS)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">4.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart-o"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pingchuan Ma</span>
</div>


        

        
      </div>
    </footer>
    
    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>
  
  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/custom/custom.js?v=5.1.2"></script>


  
    <script src="/vendors/google-code-prettify/prettify.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
      $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
      prettyPrint();
    })
    </script>
  
  
  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>


  
  


  

    

    

      
      <script type="text/javascript">
      var disqus = {
        load : function disqus(){
          if(typeof DISQUS !== 'object') {
            (function () {
              var disqus_config = function () {
                this.page.url = 'https://pingchuan.ma/set-up-nginx-with-http-2-support/';
                this.page.identifier = 'set-up-nginx-with-http-2-support/';
                this.page.title = 'Set up Nginx with HTTP/2 Support';
              };
              var d = document, s = d.createElement('script');
              s.src = 'https://openpika.disqus.com/embed.js';
              s.setAttribute('data-timestamp', '' + +new Date());
              (d.head || d.body).appendChild(s);
            }());
            $('#load-disqus').html("Comments are coming (if they work).").fadeOut(3000);
          }
        }
      }
      </script>
      
    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
</body>
</html>
